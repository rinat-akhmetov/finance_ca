<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Canada Housing Affordability â€” beta</title>

    <!-- External Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

    <!-- Application Styles -->
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="root"></div>

    <!-- Application Modules -->
    <script src="data.js"></script>
    <script src="utils.js"></script>
    <script src="components.js"></script>

    <!-- Main Application -->
    <script type="text/babel">
      // Import data and utilities from global namespaces
      const { cityData, professions } = window.HousingData || {};
      const {
        mortgagePayment,
        getMetricStatus,
        getRecommendations,
        getSuggestedCities,
        calculateCityMetrics,
      } = window.HousingUtils || {};

      // Main Application Component
      function App() {
        const cities = Object.keys(cityData);

        // Form state
        const [city, setCity] = React.useState("");
        const [incomeMode, setIncomeMode] = React.useState("");
        const [customIncome, setCustomIncome] = React.useState("");
        const [profession, setProfession] = React.useState("");
        const [savingPreset, setSavingPreset] = React.useState("");
        const [customSave, setCustomSave] = React.useState("");
        const [rate, setRate] = React.useState("");
        const [term, setTerm] = React.useState(25);

        // UI state
        const [comparisonCities, setComparisonCities] = React.useState([]);
        const [showComparison, setShowComparison] = React.useState(false);
        const [scenarioIncome, setScenarioIncome] = React.useState(null);
        const [scenarioSavings, setScenarioSavings] = React.useState(null);
        const [scenarioRate, setScenarioRate] = React.useState(null);
        const [isMobile, setIsMobile] = React.useState(false);
        const [currentStep, setCurrentStep] = React.useState(1);
        const [showAdvanced, setShowAdvanced] = React.useState(false);

        // Mobile detection
        React.useEffect(() => {
          const checkMobile = () => {
            setIsMobile(window.innerWidth <= 768);
          };
          checkMobile();
          window.addEventListener("resize", checkMobile);
          return () => window.removeEventListener("resize", checkMobile);
        }, []);

        // Mobile wizard navigation
        const canGoToStep = (step) => {
          if (step === 1) return true;
          if (step === 2) return city !== "";
          if (step === 3) return city !== "" && incomeMode !== "";
          if (step === 4)
            return (
              city !== "" &&
              incomeMode !== "" &&
              (savingPreset !== "" || customSave !== "")
            );
          return true;
        };

        const nextStep = () => {
          if (currentStep < 4 && canGoToStep(currentStep + 1)) {
            setCurrentStep(currentStep + 1);
          }
        };

        const prevStep = () => {
          if (currentStep > 1) {
            setCurrentStep(currentStep - 1);
          }
        };

        // Core calculations
        const c = city ? cityData[city] : null;
        const hasValidData =
          c && incomeMode && (savingPreset || customSave) && rate;

        const grossIncome = hasValidData
          ? incomeMode === "median"
            ? c.medianIncome
            : incomeMode === "average"
            ? c.averageIncome
            : incomeMode === "profession"
            ? professions[profession] || 0
            : parseFloat(customIncome) || 0
          : 0;

        const savePct = hasValidData
          ? savingPreset === "custom"
            ? parseFloat(customSave) || 0
            : parseFloat(savingPreset) || 0
          : 0;

        const dpFrac = 0.1;
        const downPayment = hasValidData ? c.price * dpFrac : 0;
        const monthlySaving = (grossIncome * savePct) / 100 / 12;
        const monthsToSave =
          monthlySaving > 0 ? downPayment / monthlySaving : 0;

        const loan = hasValidData ? c.price - downPayment : 0;
        const rateNum = parseFloat(rate) || 0;
        const principalAndInterest =
          hasValidData && rateNum > 0
            ? mortgagePayment(loan, rateNum, term)
            : 0;
        const tax = hasValidData ? (c.price * c.propertyTaxRate) / 12 : 0;
        const maint = hasValidData ? (c.price * c.maintenanceRate) / 12 : 0;
        const utilities = hasValidData ? c.utilities : 0;
        const totalHousing = principalAndInterest + utilities + tax + maint;

        const netIncome = (grossIncome * 0.75) / 12;
        const RI = netIncome - totalHousing;

        let score = 0;
        if (hasValidData && c.subsistence) {
          if (RI >= 1.5 * c.subsistence) score = 100;
          else if (RI >= c.subsistence)
            score = Math.round(
              (100 * (RI - c.subsistence)) / (0.5 * c.subsistence)
            );
          else score = 0;
        }

        const paymentShare =
          grossIncome > 0
            ? (principalAndInterest / (grossIncome / 12)) * 100
            : 0;
        const coverage =
          totalHousing > 0 ? (netIncome / totalHousing) * 100 : 0;

        // Status indicators
        const saveTimeStatus = getMetricStatus("saveTime", monthsToSave, city);
        const paymentRatioStatus = getMetricStatus(
          "paymentRatio",
          paymentShare,
          city
        );
        const coverageStatus = getMetricStatus("coverage", coverage, city);
        const scoreStatus = getMetricStatus("affordabilityScore", score, city);

        // Recommendations and suggestions
        const recommendations = hasValidData
          ? getRecommendations(
              monthsToSave,
              paymentShare,
              coverage,
              score,
              grossIncome,
              city,
              c
            )
          : [];

        const citySuggestions = hasValidData
          ? getSuggestedCities(
              grossIncome,
              savePct,
              rateNum,
              term,
              city,
              score,
              cityData
            )
          : { betterOptions: [], alternatives: [], affordableOptions: [] };

        // Scenario modeling
        const currentIncome = grossIncome;
        const currentSavings = savePct;
        const currentRate = rateNum;

        const modelIncome =
          scenarioIncome !== null ? scenarioIncome : currentIncome;
        const modelSavings =
          scenarioSavings !== null ? scenarioSavings : currentSavings;
        const modelRate = scenarioRate !== null ? scenarioRate : currentRate;

        let scenarioMetrics = null;
        if (hasValidData && c) {
          const sDownPayment = c.price * 0.1;
          const sMonthlySaving = (modelIncome * modelSavings) / 100 / 12;
          const sMonthsToSave =
            sMonthlySaving > 0 ? sDownPayment / sMonthlySaving : 0;

          const sLoan = c.price - sDownPayment;
          const sPrincipalAndInterest =
            modelRate > 0 ? mortgagePayment(sLoan, modelRate, term) : 0;
          const sTax = (c.price * c.propertyTaxRate) / 12;
          const sMaint = (c.price * c.maintenanceRate) / 12;
          const sTotalHousing =
            sPrincipalAndInterest + c.utilities + sTax + sMaint;

          const sNetIncome = (modelIncome * 0.75) / 12;
          const sRI = sNetIncome - sTotalHousing;

          let sScore = 0;
          if (c.subsistence) {
            if (sRI >= 1.5 * c.subsistence) sScore = 100;
            else if (sRI >= c.subsistence)
              sScore = Math.round(
                (100 * (sRI - c.subsistence)) / (0.5 * c.subsistence)
              );
            else sScore = 0;
          }

          const sPaymentShare =
            modelIncome > 0
              ? (sPrincipalAndInterest / (modelIncome / 12)) * 100
              : 0;
          const sCoverage =
            sTotalHousing > 0 ? (sNetIncome / sTotalHousing) * 100 : 0;

          scenarioMetrics = {
            monthsToSave: sMonthsToSave,
            paymentShare: sPaymentShare,
            coverage: sCoverage,
            score: sScore,
            changes: {
              monthsToSave: sMonthsToSave - monthsToSave,
              paymentShare: sPaymentShare - paymentShare,
              coverage: sCoverage - coverage,
              score: sScore - score,
            },
          };
        }

        // Reset scenario when inputs change
        React.useEffect(() => {
          setScenarioIncome(null);
          setScenarioSavings(null);
          setScenarioRate(null);
        }, [
          city,
          incomeMode,
          customIncome,
          profession,
          savingPreset,
          customSave,
          rate,
        ]);

        return (
          <div className="container">
            <div className="header">
              <h2>Canadian Housing Affordability Tool</h2>
              <p>
                Analyze housing costs and affordability across major Canadian
                cities
              </p>
            </div>

            <div className="content">
              <div className="form-grid">
                <div className="form-group">
                  <label>City</label>
                  <SearchableSelector
                    options={cities}
                    value={city}
                    onChange={setCity}
                    placeholder="Search or select a city..."
                  />
                </div>

                <div className="form-group">
                  <label>Income Source</label>
                  <SearchableSelector
                    options={[
                      `Median Household${
                        c ? ` ($${c.medianIncome.toLocaleString()})` : ""
                      }`,
                      `Average Household${
                        c ? ` ($${c.averageIncome.toLocaleString()})` : ""
                      }`,
                      "By Profession",
                      "Custom Amount",
                    ]}
                    value={
                      incomeMode === "median"
                        ? `Median Household${
                            c ? ` ($${c.medianIncome.toLocaleString()})` : ""
                          }`
                        : incomeMode === "average"
                        ? `Average Household${
                            c ? ` ($${c.averageIncome.toLocaleString()})` : ""
                          }`
                        : incomeMode === "profession"
                        ? "By Profession"
                        : incomeMode === "custom"
                        ? "Custom Amount"
                        : ""
                    }
                    onChange={(value) => {
                      if (value.includes("Median Household"))
                        setIncomeMode("median");
                      else if (value.includes("Average Household"))
                        setIncomeMode("average");
                      else if (value.includes("By Profession"))
                        setIncomeMode("profession");
                      else if (value.includes("Custom Amount"))
                        setIncomeMode("custom");
                      else setIncomeMode("");
                    }}
                    placeholder="Select income source..."
                  />

                  {incomeMode === "profession" && (
                    <div style={{ marginTop: "1rem" }}>
                      <SearchableSelector
                        options={Object.keys(professions).map(
                          (prof) =>
                            `${prof} ($${professions[prof].toLocaleString()})`
                        )}
                        value={
                          profession
                            ? `${profession} ($${
                                professions[profession]
                                  ? professions[profession].toLocaleString()
                                  : ""
                              })`
                            : ""
                        }
                        onChange={(value) => {
                          const profName = value.split(" (")[0];
                          setProfession(profName);
                        }}
                        placeholder="Search profession..."
                      />
                    </div>
                  )}

                  {incomeMode === "custom" && (
                    <div style={{ marginTop: "1rem" }}>
                      <SearchableSelector
                        options={[
                          "$50,000",
                          "$75,000",
                          "$100,000",
                          "$125,000",
                          "$150,000",
                        ]}
                        value={customIncome}
                        onChange={setCustomIncome}
                        placeholder="Enter income amount..."
                        allowCustom={true}
                      />
                    </div>
                  )}
                </div>

                <div className="form-group">
                  <label>Savings Rate</label>
                  <SearchableSelector
                    options={[
                      "Average Canada (10%)",
                      "Aggressive Saver (15%)",
                      "Super Saver (20%)",
                      "Custom Rate",
                    ]}
                    value={
                      savingPreset === "10"
                        ? "Average Canada (10%)"
                        : savingPreset === "15"
                        ? "Aggressive Saver (15%)"
                        : savingPreset === "20"
                        ? "Super Saver (20%)"
                        : savingPreset === "custom"
                        ? "Custom Rate"
                        : ""
                    }
                    onChange={(value) => {
                      if (value.includes("10%")) setSavingPreset("10");
                      else if (value.includes("15%")) setSavingPreset("15");
                      else if (value.includes("20%")) setSavingPreset("20");
                      else if (value.includes("Custom"))
                        setSavingPreset("custom");
                      else setSavingPreset("");
                    }}
                    placeholder="Select savings rate..."
                  />

                  {savingPreset === "custom" && (
                    <div style={{ marginTop: "1rem" }}>
                      <SearchableSelector
                        options={["5%", "8%", "12%", "18%", "25%"]}
                        value={customSave}
                        onChange={setCustomSave}
                        placeholder="Enter savings rate..."
                        allowCustom={true}
                      />
                    </div>
                  )}
                </div>

                <div className="form-group">
                  <label>Mortgage Rate</label>
                  <SearchableSelector
                    options={[
                      "8% (Current Average)",
                      "12% (Higher Rate)",
                      "18% (Stress Test)",
                    ]}
                    value={
                      rate === "8"
                        ? "8% (Current Average)"
                        : rate === "12"
                        ? "12% (Higher Rate)"
                        : rate === "18"
                        ? "18% (Stress Test)"
                        : ""
                    }
                    onChange={(value) => {
                      if (value.includes("8%")) setRate("8");
                      else if (value.includes("12%")) setRate("12");
                      else if (value.includes("18%")) setRate("18");
                      else setRate("");
                    }}
                    placeholder="Select mortgage rate..."
                  />
                </div>
              </div>

              {hasValidData && (
                <div className="result">
                  <h3>Affordability Analysis</h3>
                  <div className="metrics-grid">
                    <div className={`metric ${saveTimeStatus.status}`}>
                      <div className="metric-label">
                        Time to Save Down Payment
                      </div>
                      <div className="metric-value">
                        {monthsToSave.toFixed(1)} months
                      </div>
                      <div className="metric-benchmark">
                        {saveTimeStatus.benchmark}
                      </div>
                      <div
                        className={`metric-status status-${saveTimeStatus.status}`}
                      >
                        {saveTimeStatus.status}
                      </div>
                    </div>

                    <div className={`metric ${paymentRatioStatus.status}`}>
                      <div className="metric-label">
                        Payment to Income Ratio
                      </div>
                      <div className="metric-value">
                        {paymentShare.toFixed(1)}%
                      </div>
                      <div className="metric-benchmark">
                        {paymentRatioStatus.benchmark}
                      </div>
                      <div
                        className={`metric-status status-${paymentRatioStatus.status}`}
                      >
                        {paymentRatioStatus.status}
                      </div>
                    </div>

                    <div className={`metric ${coverageStatus.status}`}>
                      <div className="metric-label">Income Coverage</div>
                      <div className="metric-value">{coverage.toFixed(1)}%</div>
                      <div className="metric-benchmark">
                        {coverageStatus.benchmark}
                      </div>
                      <div
                        className={`metric-status status-${coverageStatus.status}`}
                      >
                        {coverageStatus.status}
                      </div>
                    </div>

                    <div className={`score ${scoreStatus.status}`}>
                      <div className="score-value">{score}</div>
                      <div className="score-label">Affordability Score</div>
                      <div
                        className="metric-benchmark"
                        style={{ marginTop: "0.5rem", fontSize: "1rem" }}
                      >
                        {scoreStatus.benchmark}
                      </div>
                      <div
                        className={`metric-status status-${scoreStatus.status}`}
                        style={{ marginTop: "0.5rem" }}
                      >
                        {scoreStatus.status}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Initialize application
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
